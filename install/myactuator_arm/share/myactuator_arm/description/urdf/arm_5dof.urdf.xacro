<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="myactuator_arm">
  <xacro:arg name="pkg_share" default=""/>
  <xacro:arg name="num_joints" default="5"/>

  <xacro:property name="num_joints" value="$(arg num_joints)"/>

  <!-- Base link (fixed to world) -->
  <link name="world"/>

  <!-- Joint 1 (EtherCAT slave position 0) -->
  <xacro:if value="${num_joints >= 1}">
    <link name="link1">
      <visual>
        <geometry>
          <cylinder radius="0.05" length="0.1"/>
        </geometry>
        <material name="blue">
          <color rgba="0.2 0.2 0.8 1"/>
        </material>
      </visual>
    </link>

    <joint name="joint1" type="revolute">
      <parent link="world"/>
      <child link="link1"/>
      <origin xyz="0 0.3 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-3.14" upper="3.14" velocity="16.0" effort="20.0"/>
    </joint>
  </xacro:if>

  <!-- Joint 2 (EtherCAT slave position 1) -->
  <xacro:if value="${num_joints >= 2}">
    <link name="link2">
      <visual>
        <geometry>
          <cylinder radius="0.05" length="0.1"/>
        </geometry>
        <material name="green">
          <color rgba="0.2 0.8 0.2 1"/>
        </material>
      </visual>
    </link>

    <joint name="joint2" type="revolute">
      <parent link="world"/>
      <child link="link2"/>
      <origin xyz="0 0.15 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-3.14" upper="3.14" velocity="16.0" effort="20.0"/>
    </joint>
  </xacro:if>

  <!-- Joint 3 (EtherCAT slave position 2) -->
  <xacro:if value="${num_joints >= 3}">
    <link name="link3">
      <visual>
        <geometry>
          <cylinder radius="0.05" length="0.1"/>
        </geometry>
        <material name="red">
          <color rgba="0.8 0.2 0.2 1"/>
        </material>
      </visual>
    </link>

    <joint name="joint3" type="revolute">
      <parent link="world"/>
      <child link="link3"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-3.14" upper="3.14" velocity="16.0" effort="20.0"/>
    </joint>
  </xacro:if>

  <!-- Joint 4 (EtherCAT slave position 3) -->
  <xacro:if value="${num_joints >= 4}">
    <link name="link4">
      <visual>
        <geometry>
          <cylinder radius="0.05" length="0.1"/>
        </geometry>
        <material name="yellow">
          <color rgba="0.8 0.8 0.2 1"/>
        </material>
      </visual>
    </link>

    <joint name="joint4" type="revolute">
      <parent link="world"/>
      <child link="link4"/>
      <origin xyz="0 -0.15 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-3.14" upper="3.14" velocity="16.0" effort="20.0"/>
    </joint>
  </xacro:if>

  <!-- Joint 5 (EtherCAT slave position 4) -->
  <xacro:if value="${num_joints >= 5}">
    <link name="link5">
      <visual>
        <geometry>
          <cylinder radius="0.05" length="0.1"/>
        </geometry>
        <material name="purple">
          <color rgba="0.8 0.2 0.8 1"/>
        </material>
      </visual>
    </link>

    <joint name="joint5" type="revolute">
      <parent link="world"/>
      <child link="link5"/>
      <origin xyz="0 -0.3 0" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="-3.14" upper="3.14" velocity="16.0" effort="20.0"/>
    </joint>
  </xacro:if>

  <!-- ros2_control configuration - CST (Torque) mode -->
  <ros2_control name="EthercatSystem" type="system">
    <hardware>
      <plugin>ethercat_driver/EthercatDriver</plugin>
      <param name="master_id">0</param>
      <param name="control_frequency">250</param>
    </hardware>

    <!-- Joint 1 - EtherCAT slave position 0 -->
    <xacro:if value="${num_joints >= 1}">
      <joint name="joint1">
        <command_interface name="velocity"/>
        <command_interface name="position"/>
        <command_interface name="effort"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
        <ec_module name="MyActuatorX6_Joint1">
          <plugin>ethercat_generic_plugins/EcCiA402Drive</plugin>
          <param name="alias">0</param>
          <param name="position">0</param>
          <param name="slave_config">$(arg pkg_share)/config/ethercat/joint1_motor.yaml</param>
          <param name="mode_of_operation">10</param>
        </ec_module>
      </joint>
    </xacro:if>

    <!-- Joint 2 - EtherCAT slave position 1 -->
    <xacro:if value="${num_joints >= 2}">
      <joint name="joint2">
        <command_interface name="velocity"/>
        <command_interface name="position"/>
        <command_interface name="effort"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
        <ec_module name="MyActuatorX6_Joint2">
          <plugin>ethercat_generic_plugins/EcCiA402Drive</plugin>
          <param name="alias">0</param>
          <param name="position">1</param>
          <param name="slave_config">$(arg pkg_share)/config/ethercat/joint2_motor.yaml</param>
          <param name="mode_of_operation">10</param>
        </ec_module>
      </joint>
    </xacro:if>

    <!-- Joint 3 - EtherCAT slave position 2 -->
    <xacro:if value="${num_joints >= 3}">
      <joint name="joint3">
        <command_interface name="velocity"/>
        <command_interface name="position"/>
        <command_interface name="effort"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
        <ec_module name="MyActuatorX6_Joint3">
          <plugin>ethercat_generic_plugins/EcCiA402Drive</plugin>
          <param name="alias">0</param>
          <param name="position">2</param>
          <param name="slave_config">$(arg pkg_share)/config/ethercat/joint3_motor.yaml</param>
          <param name="mode_of_operation">10</param>
        </ec_module>
      </joint>
    </xacro:if>

    <!-- Joint 4 - EtherCAT slave position 3 -->
    <xacro:if value="${num_joints >= 4}">
      <joint name="joint4">
        <command_interface name="velocity"/>
        <command_interface name="position"/>
        <command_interface name="effort"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
        <ec_module name="MyActuatorX6_Joint4">
          <plugin>ethercat_generic_plugins/EcCiA402Drive</plugin>
          <param name="alias">0</param>
          <param name="position">3</param>
          <param name="slave_config">$(arg pkg_share)/config/ethercat/joint4_motor.yaml</param>
          <param name="mode_of_operation">10</param>
        </ec_module>
      </joint>
    </xacro:if>

    <!-- Joint 5 - EtherCAT slave position 4 -->
    <xacro:if value="${num_joints >= 5}">
      <joint name="joint5">
        <command_interface name="velocity"/>
        <command_interface name="position"/>
        <command_interface name="effort"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
        <state_interface name="effort"/>
        <ec_module name="MyActuatorX6_Joint5">
          <plugin>ethercat_generic_plugins/EcCiA402Drive</plugin>
          <param name="alias">0</param>
          <param name="position">4</param>
          <param name="slave_config">$(arg pkg_share)/config/ethercat/joint5_motor.yaml</param>
          <param name="mode_of_operation">10</param>
        </ec_module>
      </joint>
    </xacro:if>
  </ros2_control>

</robot>
